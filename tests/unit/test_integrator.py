"""
Unit tests for ODE solver integration outputs.
"""

import numpy as np
import pytest

from preference_dynamics.schemas import (
    ICVector,
    ODEConfig,
    ODESolverConfig,
    ParameterVector,
    SolverConfig,
)
from preference_dynamics.solver.integrator import solve_ODE


class TestSolveODE:
    def test_time_series_matches_expected_values(self) -> None:
        """Verify solve_ODE produces the expected trajectory."""
        parameters = ParameterVector.from_dict(
            {
                "n_actions": 2,
                "g": [1.0, 0.0],
                "mu": [0.0, 1.0],
                "Pi": [[1.0, 0.0], [-0.5, 1.0]],
                "Gamma": [[1.0, 1.0], [1.0, 1.0]],
            }
        )
        initial_conditions = ICVector(values=np.array([1.0, -2.0, -3.0, 2.0]))
        ode_config = ODEConfig(parameters=parameters, initial_conditions=initial_conditions)
        solver_config = SolverConfig(time_span=(0.0, 50.0), n_time_points=51)
        config = ODESolverConfig(ode=ode_config, solver=solver_config)

        sample = solve_ODE(config)

        expected_time_series = np.array(
            [
                [1.0, 1.0, 9.193114719783341e-187, 2.0],
                [2.0000000000000004, 1.0, -1.9216655069357903e-280, 1.367879454398837],
                [2.999999999999997, 1.0, 0.0, 1.135335314296138],
                [3.950779255260924, 1.0, 0.5004172166330741, 1.0036140080950744],
                [3.4454323696865172, 1.0, 2.3017377435432715, 0.0],
                [1.9187655384635778, 1.0, 2.4689258346876195, 0.0],
                [0.8224272969214129, 1.0, 1.6755360670358874, 0.0],
                [0.5224519091324022, 1.0, 0.9905115900966022, 0.0],
                [0.6900235725925141, 1.0, 0.7440272760246225, 0.0],
                [0.9320717912932385, 1.0, 0.8023233824656273, 0.0],
                [1.060649684736211, 1.0, 0.9388143432179457, 0.0],
                [1.0726537035292303, 1.0, 1.024635857484441, 0.0],
                [1.0347863075280677, 1.0, 1.041870203010138, 0.0],
                [1.0006104879254112, 1.0, 1.02384251158328, 0.0],
                [0.9876825717738477, 1.0, 1.0033344650030935, 0.0],
                [0.9900952107308406, 1.0163904862563558, 0.9938493413808889, 0.0],
                [0.9967472444011373, 1.5130644694212088, 0.9939395866369861, 0.0],
                [1.0010874268146899, 2.0108943782144335, 0.997499801406885, 0.0],
                [1.0020512949369893, 2.510412444153279, 1.0002646318748034, 0.0],
                [1.1186519066071305, 2.4588655739243355, 0.6531240951131557, 1.020531237978302],
                [1.677156468781273, 1.429522196987622, 0.33163176668508587, 1.3113740103214684],
                [2.197265303507687, 1.0000000000000002, 0.7325861110857804, 0.8246364549160958],
                [2.1401123337209884, 0.9999999999999999, 1.3641314873929193, 0.23418981653903093],
                [1.581545574782271, 1.306421361885394, 1.6438753578663599, 0.0],
                [1.0401335846194941, 2.0771273569798736, 1.3915111995024758, 0.0],
                [0.8803032214095087, 2.3670634339439753, 0.8567877643615383, 0.7089891672467592],
                [1.3215362006392801, 1.6322272415893535, 0.3406293816037986, 1.1992856890815375],
                [1.9546632385857263, 0.9999999999997645, 0.5205818623581882, 0.9199040913511852],
                [2.1393618475311023, 0.9999999827471356, 1.1220526351558622, 0.4234527444970955],
                [1.7625999550006326, 0.9999999999999992, 1.570335772336973, 0.0],
                [1.198809122300216, 1.7415024347400399, 1.4788249224995016, 0.0],
                [0.8850382685955953, 2.323349860018382, 1.1017884520963972, 0.36034882301576154],
                [1.0930543120270162, 1.9737524860572173, 0.5019520778868047, 1.0559076055612597],
                [1.7115679546758842, 1.0375238830530482, 0.3858356213738071, 1.0582272038164433],
                [2.1026548712808513, 1.0000000000019853, 0.8866312917832623, 0.6099362623712902],
                [1.9302232543178464, 0.9999999961980599, 1.4258572830279714, 0.08732758908399507],
                [1.3904150382891582, 1.500204439170367, 1.5487763491688835, 0.0],
                [0.965355881457926, 2.2018759485425448, 1.2672821800209668, 0.13137620795763977],
                [0.980697227873171, 2.165700169881511, 0.6765733577087806, 0.8916559337232415],
                [1.5160837957369389, 1.3226176657946762, 0.3577283454798872, 1.1296238176706948],
                [2.025930775347489, 0.9999999999999999, 0.714981744718164, 0.7418039710723582],
                [2.0201196990463792, 1.0000000000000004, 1.2836400577879983, 0.23945791830063948],
                [1.5495452615037495, 1.2992380252199769, 1.566753381998557, 0.0],
                [1.0601681478966907, 2.0439265820235106, 1.3647067762476899, 0.0],
                [0.9286301867036296, 2.26459811742361, 0.8373126585085574, 0.725910147129272],
                [1.3580475634988594, 1.5628791989580166, 0.38440384166182345, 1.136225393849747],
                [1.9304777951186107, 0.9999999999999962, 0.5857057042302385, 0.8459258231039323],
                [2.0650689908665645, 1.0000000011985921, 1.1519166927141977, 0.36645867928564996],
                [1.6830726210510598, 1.1234024879294717, 1.5477493289757354, 0.0],
                [1.158394956021836, 1.885741320365704, 1.4335462212605243, 0.0],
                [0.9145418196352676, 2.3011919467739768, 0.9820126320897821, 0.5639257923141864],
            ],
            dtype=float,
        )

        np.testing.assert_allclose(sample.time_points, np.linspace(0.0, 50.0, 51))
        np.testing.assert_allclose(
            sample.time_series.T,
            expected_time_series,
            rtol=1e-3,
            atol=1e-4,
        )

    def test_invalid_time_span_raises_value_error(self) -> None:
        with pytest.raises(ValueError, match="t_end must be > t_start"):
            SolverConfig(time_span=(1.0, 0.0), n_time_points=10)
